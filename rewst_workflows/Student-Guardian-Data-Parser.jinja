{#
  Rewst Workflow: Skyward Student and Guardian Data Parser
  
  Purpose: Parses Skyward API responses to extract student information and 
           primary guardian details with mailing address
  
  Author: Bryan Faulkner, with assistance from Claude
  Version: 1.0.0
  
  Input Variables Required:
  - CTX.input_first_name: Student's first name
  - CTX.input_last_name: Student's last name
  - CTX.all_students: Array of all students from Skyward API
  - CTX.guardians_list: Array of all guardians from Skyward API
  
  Output: JSON object with student and primary_guardian data
#}

{% set target_first_name = CTX.input_first_name | lower | trim %}
{% set target_last_name = CTX.input_last_name | lower | trim %}

{# Find the matching student #}
{% set found_student = namespace(value=none) %}
{% for student in CTX.all_students %}
  {% if student.FirstName | lower == target_first_name and student.LastName | lower == target_last_name %}
    {% set found_student.value = student %}
  {% endif %}
{% endfor %}

{# Find guardians for this student and collect with FamilyOrderNumber #}
{% set student_guardians = [] %}
{% for guardian in CTX.guardians_list %}
  {% for student_relation in guardian.Students %}
    {% if student_relation.StudentNameId == found_student.value.NameId %}
      {% set _ = student_guardians.append({
        "guardian": guardian,
        "family_order": student_relation.FamilyOrderNumber,
        "guardian_order": student_relation.GuardianOrderNumber
      }) %}
    {% endif %}
  {% endfor %}
{% endfor %}

{# Sort guardians by FamilyOrderNumber (primary family contact first) #}
{% set sorted_guardians = student_guardians | sort(attribute='family_order') %}

{# Use the guardian with FamilyOrderNumber = 1 (primary family contact) #}
{% set primary_guardian = namespace(value=none) %}
{% for guardian_info in sorted_guardians %}
  {% if guardian_info.family_order == 1 %}
    {% set primary_guardian.value = guardian_info.guardian %}
  {% endif %}
{% endfor %}

{# If no FamilyOrderNumber 1, use the first one in the sorted list #}
{% if primary_guardian.value is none and sorted_guardians | length > 0 %}
  {% set primary_guardian.value = sorted_guardians[0].guardian %}
{% endif %}

{# Determine which address to use - prefer mailing address, fallback to physical address #}
{% set use_mailing = primary_guardian.value.MailStreetAddress and primary_guardian.value.MailStreetAddress != "" %}

{
  "success": true,
  "student": {
    "first_name": "{{ found_student.value.FirstName }}",
    "last_name": "{{ found_student.value.LastName }}",
    "graduation_year": {{ found_student.value.GradYr }},
    "student_id": {{ found_student.value.NameId }},
    "display_id": "{{ found_student.value.DisplayId }}",
    "default_school_id": "{{ found_student.value.DefaultSchoolId }}"
  },
  "primary_guardian": {
    "guardian_id": {{ primary_guardian.value.GuardianNameId }},
    "first_name": "{{ primary_guardian.value.FirstName }}",
    "last_name": "{{ primary_guardian.value.LastName }}",
    "full_name": "{{ primary_guardian.value.DisplayNameFML }}",
    "email": "{{ primary_guardian.value.Email if primary_guardian.value.Email else '' }}",
    "phone_number": "{{ primary_guardian.value.PhoneNumber if primary_guardian.value.PhoneNumber else '' }}",
    "mailing_address": {
      "street": "{{ primary_guardian.value.MailStreetAddress if use_mailing else primary_guardian.value.StreetAddress }}",
      "city": "{{ primary_guardian.value.MailCity if use_mailing else primary_guardian.value.City }}",
      "state": "{{ primary_guardian.value.MailState if use_mailing else primary_guardian.value.State }}",
      "zip_code": "{{ primary_guardian.value.MailZipCode if use_mailing else primary_guardian.value.ZipCode }}",
      "full_address": "{{ primary_guardian.value.MailOneLineAddress if use_mailing else primary_guardian.value.OneLineAddress }}",
      "address_type": "{{ 'mailing' if use_mailing else 'physical' }}"
    }
  },
  "retrieved_at": "{{ now() }}"
}
