{% set target_first_name = CTX.input_first_name | lower | trim %}
{% set target_last_name = CTX.input_last_name | lower | trim %}

{# Find the matching student by first name and last name #}
{% set found_student = namespace(value=none) %}
{% for student in CTX.all_students %}
  {% if student.FirstName | lower == target_first_name 
     and student.LastName | lower == target_last_name %}
    {% set found_student.value = student %}
  {% endif %}
{% endfor %}

{# Find guardians for this student and collect with FamilyOrderNumber, GuardianOrderNumber, and IsCustodial #}
{% set student_guardians = [] %}
{% if found_student.value %}
  {% for guardian in CTX.guardians_list %}
    {% for student_relation in guardian.Students %}
      {% if student_relation.StudentNameId == found_student.value.NameId %}
        {% set _ = student_guardians.append({
          "guardian": guardian,
          "family_order": student_relation.FamilyOrderNumber,
          "guardian_order": student_relation.GuardianOrderNumber,
          "is_custodial": student_relation.IsCustodial
        }) %}
      {% endif %}
    {% endfor %}
  {% endfor %}
{% endif %}

{# Sort guardians by: 1) FamilyOrderNumber, 2) IsCustodial (true first), 3) GuardianOrderNumber #}
{# Note: Jinja sort is ascending, so we use negative values for IsCustodial to get true (1) before false (0) #}
{% set sorted_guardians = student_guardians | sort(attribute='guardian_order') | sort(attribute='is_custodial', reverse=true) | sort(attribute='family_order') %}

{# Use the first guardian after sorting (should be FamilyOrder 1, Custodial, lowest GuardianOrder) #}
{% set primary_guardian = namespace(value=none) %}
{% if sorted_guardians | length > 0 %}
  {% set primary_guardian.value = sorted_guardians[0].guardian %}
{% endif %}

{# Build result only if we found both student and guardian #}
{% if found_student.value and primary_guardian.value %}
  {# Determine which address to use - prefer mailing address, fallback to physical address #}
  {% set use_mailing = primary_guardian.value.MailStreetAddress and primary_guardian.value.MailStreetAddress != "" %}

  {% set result = {
    "success": true,
    "student": {
      "first_name": found_student.value.FirstName.replace(' ', '.'),
      "last_name": found_student.value.LastName.replace(' ', '.'),
      "graduation_year": found_student.value.GradYr,
      "student_id": found_student.value.NameId,
      "display_id": found_student.value.DisplayId,
      "default_school_id": found_student.value.DefaultSchoolId
    },
    "primary_guardian": {
      "guardian_id": primary_guardian.value.GuardianNameId,
      "first_name": primary_guardian.value.FirstName.replace(' ', '-'),
      "last_name": primary_guardian.value.LastName.replace(' ', '-'),
      "full_name": primary_guardian.value.DisplayNameFML,
      "email": primary_guardian.value.Email if primary_guardian.value.Email else '',
      "phone_number": primary_guardian.value.PhoneNumber if primary_guardian.value.PhoneNumber else '',
      "mailing_address": {
        "street": primary_guardian.value.MailStreetAddress if use_mailing else primary_guardian.value.StreetAddress,
        "city": primary_guardian.value.MailCity if use_mailing else primary_guardian.value.City,
        "state": primary_guardian.value.MailState if use_mailing else primary_guardian.value.State,
        "zip_code": primary_guardian.value.MailZipCode if use_mailing else primary_guardian.value.ZipCode,
        "full_address": primary_guardian.value.MailOneLineAddress if use_mailing else primary_guardian.value.OneLineAddress,
        "address_type": 'mailing' if use_mailing else 'physical'
      }
    },
    "retrieved_at": now()
  } %}
  {{ result | tojson }}
{% else %}
  {% set error_result = {
    "success": false,
    "error": "Student or guardian not found",
    "searched_for": {
      "first_name": target_first_name,
      "last_name": target_last_name
    }
  } %}
  {{ error_result | tojson }}
{% endif %}
